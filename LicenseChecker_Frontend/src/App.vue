<template>
  <div>
    <q-layout view="hHh lpR fff">
      <q-page-container>
        <Header_nav @scroll-to-disclaimer="scrollToDisclaimer" :header_label="header_label" :header_icon="header_icon"
          @changeHeaderLabel="changeHeaderLabel" />

        <router-view @selected-rows="updateSelectedRows" :selected-rows="selectedRows" :licenseid="licenseid"
          @changeHeaderLabel="changeHeaderLabel" @githubpost="githubpost" @generateid="generateid"
          @changeLicenseName="changeLicenseName" @listCompatibleLicenses="listCompatibleLicenses"
          :errorMessage="errorMessage" :compatibleLicenses="compatibleLicenses" :allLicenses="allLicenses"
          :detailedCompatibleLicenses="detailedCompatibleLicenses"
          :detailedCompatibleLicensesId="detailedCompatibleLicensesId" @changedetailedCompatibleLicensesId="changedetailedCompatibleLicensesId
            " @getCompatibleLicenses="getCompatibleLicenses" @uploadZipFile="uploadZipFile" />
      </q-page-container>

      <q-footer elevated>
        <Footer_nav ref="footerNav" />
      </q-footer>
    </q-layout>
  </div>
</template>

<script>
import Header_nav from "./components/Header.vue";
import Footer_nav from "./components/Footer.vue";
import recommendationIcon from '@/assets/License-Recommendation.svg';
import licensesearch from '@/assets/License-Search.svg';
import licensechecker from '@/assets/License-Checker.svg';
import help from '@/assets/License-Help.svg';
import detailinfo from '@/assets/detail-info.svg';



import axios from "axios";
import { mapGetters } from 'vuex';
export default {
  name: "App",
  components: {
    Header_nav,
    Footer_nav,

  },

  data: () => ({
    header_label: "License Checker",
    header_icon: "licensechecker",

    hello: null,
    id: null,
    postResponse: null,
    allLicenses: [],
    allLicensesFields: null,
    compatibleLicenses: [],
    licenseid: null,
    detailedCompatibleLicensesId: [],
    selectedRows: [],

    errorMessage: null,



  }),

  methods: {

    scrollToDisclaimer() {
      this.$nextTick(() => {
        // Ensure the footer component is rendered and available
        const footer = this.$refs.footerNav?.$el;
        console.log('Footer Element:', footer);  // Debugging

        const disclaimer = footer?.querySelector('.disclaimer-text');
        console.log('Disclaimer Element:', disclaimer);  // Debugging

        if (disclaimer) {
          // Scroll smoothly to the disclaimer section
          disclaimer.scrollIntoView({ behavior: 'smooth' });

          // Add a class to highlight the disclaimer
          disclaimer.classList.add('highlight');

          // Remove the highlight after 3 seconds
          setTimeout(() => {
            disclaimer.classList.remove('highlight');
          }, 3000);
        } else {
          console.error("Disclaimer section not found!");
        }
      });
    },
    updateSelectedRows(rows) {
      console.log("Selected rows from app.vue", rows);
      this.selectedRows = rows;
    },
    changeLicenseName(licenseid) {
      /*Stores the license id in session storage to make it persistent   */
      sessionStorage.setItem("licenseid", licenseid);
      this.licenseid = sessionStorage.getItem("licenseid");
    },

    changedetailedCompatibleLicensesId(changedId) {
      console.log("In app.vue: received licenses", changedId);
      this.detailedCompatibleLicensesId = changedId;
    },

    changeHeaderLabel(headerlabel) {
      /* Change header label */
      this.header_label = headerlabel;

    },

    generateid() {
      this.id =
        "id-" +
        Math.random().toString(36).substring(2, 9) +
        "-" +
        Date.now().toString(36);
      //console.log(this.id)
    },

    githubpost(bodyFormData, repoName, softwareid) {
      /* Posts data to github */
      axios({
        method: "post",
        url: this.engineURL + "/api/v1/software",
        data: {
          id: softwareid,
          name: repoName,
          url: bodyFormData.url,
          branch: bodyFormData.branch,
        },
        headers: {
          "Content-Type": "application/json",
        },

      })
        .then((response) => {
          this.postResponse = response;
          this.errorMessage = null;
          // this.uploadSuccess = true;
          console.log("Upload is Sucessful.")
        })
        .catch((error) => {
          // Handle error
          if (error.response) {
            this.errorMessage = error.response.data.message;
            console.error("Response Error Data:", error.response.data.message);
            console.error("Response Error Status:", error.response.status);
          }
        });
    },
    async uploadZipFile(fileName, file) {
      this.$q.loading.show({
        message: 'Searching for licenses',
        boxClass: 'bg-blue text-secondary',
        spinnerColor: 'primary'
      });

      function isZipFile(arrayBuffer) {
        const signature = new Uint8Array(arrayBuffer).subarray(0, 4);
        // ZIP‑Dateien beginnen mit den ASCII‑Bytes: 0x50 0x4B 0x03 0x04 ("PK\u0003\u0004")
        return (
          signature[0] === 0x50 && // 'P'
          signature[1] === 0x4b && // 'K'
          signature[2] === 0x03 &&
          signature[3] === 0x04
        );
      }

      const slice = file.slice(0, 4);
      try {
        const arrayBuffer = await slice.arrayBuffer();
        const zip = isZipFile(arrayBuffer);
        if (zip === true) {
          // SHA256 + VirusTotal check
          try {
            const fullBuffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', fullBuffer);
            const sha256 = Array.from(new Uint8Array(hashBuffer))
              .map(b => b.toString(16).padStart(2, '0'))
              .join('');
            console.log("File SHA256:", sha256);

            const vtApiKey = import.meta.env.VITE_VIRUSTOTAL_API_KEY;
            if (vtApiKey) {
              this.$q.loading.show({
                message: 'Checking file with VirusTotal...',
                boxClass: 'bg-blue text-secondary',
                spinnerColor: 'primary'
              });
              try {
                const vtResponse = await axios.get(
                  `https://www.virustotal.com/api/v3/files/${sha256}`,
                  { headers: { 'x-apikey': vtApiKey } }
                );
                const stats = vtResponse.data?.data?.attributes?.last_analysis_stats;
                if (stats && stats.malicious > 0) {
                  this.$q.loading.hide();
                  this.errorMessage = `VirusTotal flagged this file as malicious (${stats.malicious} detection(s)). Upload blocked.`;
                  console.error("VirusTotal: file flagged as malicious", stats);
                  return;
                }
                console.log("VirusTotal: file is clean", stats);
              } catch (vtError) {
                if (vtError.response?.status === 404) {
                  // File unknown to VirusTotal – proceed with upload
                  console.log("VirusTotal: file not in database, proceeding");
                } else if (vtError.response?.status === 429) {
                  this.$q.loading.hide();
                  this.$q.dialog({
                    title: 'VirusTotal Rate Limit Reached',
                    message: 'The VirusTotal API limit of 4 requests per minute has been exceeded. Please wait a moment and try again.',
                    ok: { label: 'OK', color: 'primary' },
                  });
                  return;
                } else {
                  // API unreachable or other error – warn but don't block upload
                  console.warn("VirusTotal check failed, proceeding:", vtError.message);
                }
              }
            }
          } catch (hashError) {
            // Crypto API failure – warn but don't block upload
            console.warn("SHA256 computation failed, proceeding:", hashError);
          }

          const formData = new FormData()

          formData.append("filename", fileName);
          formData.append("uploadType", "file");
          formData.append("folderId", "1");
          formData.append("file", file)
          try {
            const response = await axios({
              method: "post",
              url: this.engineURL + "/api/v1/software/upload",
              data: formData,
              timeout: 300000,
            });
            this.postResponse = response;
            this.errorMessage = null;
            console.log("Upload is Sucessful");
          } catch (error) {
            if (error.response) {
              this.errorMessage = error.response.data.message;
              console.error("Response Error Data:", error.response.data.message);
              console.error("Response Error Status:", error.response.status);
            } else {
              this.errorMessage = error.message;
              console.error("Upload error:", error.message);
            }
          }
        } else {
          this.$q.loading.hide();
          this.errorMessage = "The uploaded file is not a valid zip file.";
          console.log("The uploaded file is no zip file");
        }
      } catch (err) {
        this.$q.loading.hide();
        this.errorMessage = "Error reading the file.";
        console.error(err);
      }
    },
    listCompatibleLicenses(cl) {
      this.compatibleLicenses = cl;
    },
    getCompatibleLicenses(list) {
      /* Gets Compatible Licenses from backend */
      axios
        .post(this.backendURL + "/licenses/check/", list)
        .then((response) => {
          this.compatibleLicenses = response.data;
        })
        .catch((error) => {
          console.error("Error fetching results:", error);
        });
    },
  },
  mounted() {
    axios.get(this.backendURL + "/licenses/").then(
      (response) => (this.allLicenses = response.data)
    );

  },
  watch: {
    /* Changes header label based on routes */
    $route() {
      if (this.$route.path == "/") {
        this.header_label = "License Checker";
        this.header_icon = licensechecker;
      } else if (this.$route.path == "/licenseRecommendation") {
        this.header_label = "License Recommendation";
        this.header_icon = recommendationIcon;
      } else if (this.$route.path == "/LicenseSearch") {
        this.header_label = "License Search";
        this.header_icon = licensesearch;
      } else if (this.$route.path == "/LicenseDetails") {
        this.header_label = "License Details";
        this.header_icon = detailinfo;
      } else if (this.$route.path == "/compatibleLicenses") {
        this.header_label = "Compatible Licenses";
      } else if (this.$route.path == "/help") {
        this.header_label = "Help";
        this.header_icon = help;
      } else {
        //do nothing
      }

    },
  },
  computed: {
    detailedCompatibleLicenses() {
      /* Filters the detail of compatible Licenses */
      return this.allLicenses.filter((item) =>
        this.compatibleLicenses.includes(item.id)
      );
    },
  },
};
</script>
